<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="/css/styles.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="map-container">
  <h1>NYC Parks Map</h1>
  
  <div class="map-filters">
    <label>
      <input type="checkbox" id="showParks" checked> Show Parks
    </label>
  </div>
  
  <div id="map"></div>
  
  <div class="map-legend">
    <h3>Legend</h3>
    <div><span class="legend-marker park-marker">üèûÔ∏è</span> Parks</div>
  </div>
</div>

<script>
  const map = L.map('map').setView([40.7128, -74.0060], 11);
  
  // Add map tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19
  }).addTo(map);
  
  // Get facilities data from server
  const facilities = {{{facilitiesJson}}};
  
  // Create marker groups
  const parkMarkers = L.layerGroup().addTo(map);
  const recMarkers = L.layerGroup().addTo(map);
  
  // Custom icons
  const parkIcon = L.divIcon({
  html: '<span class="emoji-icon">üèûÔ∏è</span>',
  className: '', // important: prevents extra Leaflet styles
  iconSize: [30, 30], // hitbox size
  iconAnchor: [15, 30] // center the emoji on the marker point
  });

  const recIcon = L.divIcon({
  html: '<span class="emoji-icon">üèÄ</span>',
  className: '',
  iconSize: [30, 30],
  iconAnchor: [15, 30]
  });
  
  // Add markers for each facility
  facilities.forEach(facility => {
    if (!facility.lat || !facility.lng) return;
    
    const name = facility.parkName || facility.recCenterName;
    const type = facility.park ? 'Park' : 'Recreation Center';
    const icon = facility.park ? parkIcon : recIcon;
    const group = facility.park ? parkMarkers : recMarkers;
    
    const popupContent = `
      <div class="marker-popup">
        <h3>${name}</h3>
        <p><strong>Type:</strong> ${type}</p>
        <p><strong>Borough:</strong> ${facility.borough}</p>
        <p><strong>Address:</strong> ${facility.streetAddress}</p>
        ${facility.size ? `<p><strong>Size:</strong> ${facility.size} acres</p>` : ''}
        <a href="/facility/${facility._id}" class="view-link">View Details</a>
      </div>
    `;
    
    L.marker([facility.lat, facility.lng], { icon: icon })
      .bindPopup(popupContent)
      .addTo(group);
  });
  
  // Filter controls
  document.getElementById('showParks').addEventListener('change', (e) => {
    if (e.target.checked) {
      map.addLayer(parkMarkers);
    } else {
      map.removeLayer(parkMarkers);
    }
  });
  
  document.getElementById('showRecCenters').addEventListener('change', (e) => {
    if (e.target.checked) {
      map.addLayer(recMarkers);
    } else {
      map.removeLayer(recMarkers);
    }
  });
</script>

<style>
.map-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.map-container h1 {
  margin-bottom: 20px;
  text-align: center;
}

.map-filters {
  background-color: #f7fafc;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 5px;
  display: flex;
  gap: 20px;
  justify-content: center;
}

.map-filters label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: bold;
  cursor: pointer;
}

.map-filters input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

#map {
  height: 600px;
  width: 100%;
  border: 2px solid #ccc;
  border-radius: 5px;
  margin-bottom: 20px;
}

.map-legend {
  background-color: #f7fafc;
  padding: 15px;
  border-radius: 5px;
  max-width: 300px;
}

.map-legend h3 {
  margin-top: 0;
  margin-bottom: 10px;
}

.map-legend div {
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.legend-marker {
  font-size: 20px;
}

.custom-icon {
  background: none;
  border: none;
  font-size: 24px;
  text-align: center;
  line-height: 30px;
}

.marker-popup h3 {
  margin-top: 0;
  margin-bottom: 10px;
  color: #333;
}

.marker-popup p {
  margin: 5px 0;
  color: #555;
}

.marker-popup .view-link {
  display: inline-block;
  margin-top: 10px;
  padding: 8px 16px;
  background-color: #4299e1;
  color: white;
  text-decoration: none;
  border-radius: 3px;
}

.marker-popup .view-link:hover {
  background-color: #3182ce;
}

@media (max-width: 768px) {
  #map {
    height: 400px;
  }
  
  .map-filters {
    flex-direction: column;
    align-items: flex-start;
  }
}
</style>